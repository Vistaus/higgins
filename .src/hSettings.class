' Gambas class file

Public Sub Button1_Click()
  Try FMain.xb.close()
  FMain.setup_xbindkeys()
  If FMain.xb.init_error Then
    Try FMain.setup_xbindkeys()
    If FMain.xb.init_error Then 
      FMain.xb_show_init_error(True)
      Return
    Endif
  Endif
  Me.mouse = Mouse.wait
  Wait 0.1
  Me.enabled = False
  Wait
  Message.Info("A blank window will open shortly,\nPlease press the desidered shortcut there.")
  FMain.xb.clear_hotkeys()
  FMain.xb.register("show")
  Me.enabled = True
  Me.mouse = Mouse.normal
  ShowShortcut()
End

Public Sub Form_Hide()
  If Me.closed Then Return
  MySettings.save()
  FMain.Show()
End

Public Sub ComboboxTerminalEmulator_Change()
  Settings["terminal_emulator"] = ComboboxTerminalEmulator.text
  Settings.Save()
End

Public Sub Panel1_BeforeArrange()
  ShowShortcut()
End

Private Sub ShowShortcut()

  Dim s As String[]

  hSettings.button1.text = ("Change")
  Try s = Split(File.Load(FMain.xb_rcpath), "\n", "", True)

  If Error Then Return

  hSettings.button1.text = s[s.max]
 
End

Public Sub ButtonOpenExtPlugin_Click()

  Desktop.Open(FMain.extbinpath)

End

Public Sub UpdateIconThemes()
  Dim theme As String
  Dim extext As String = ComboboxIconThemes.text
  Object.Lock(ComboboxIconThemes)
    ComboboxIconThemes.Clear()
  Object.unLock(ComboboxIconThemes)
  For Each theme In Stock.Themes
    If ComboboxIconThemes.Find(theme) < 0 Then
      ComboboxIconThemes.Add(theme)
    Endif
  Next
  ComboboxIconThemes.text = extext
End


Public Sub Panel2_Arrange()
  
  UpdateIconThemes()

End

Public Sub ComboboxIconThemes_Change()
  Settings["icon_theme"] = ComboboxIconThemes.text
  Debug Settings["icon_theme"] 
  Settings.Save()
End




Public Sub ColorButton1_Change()
  Applystyle()
  Settings["style/background"] = ColorButton1.value
  Settings.Save
End

Public Sub Button2_Click()
  ColorButton1.value = Color.Background
  Settings["style/background"] = ColorButton1.value
  Settings.Save
  Applystyle()
End


Public Sub Applystyle()
  Dim wopacity As Integer
  Dim wopacitygrid As Integer
  
  If Not Global.fullyloaded Then Return
  'window background 
    If ColorButton1.value = Color.background Then 
      FMain.Background = -1
        Else
      FMain.Background = ColorButton1.value
    Endif
  
  'padding 
    FMain.padding = CInt(Desktop.scale * (SpinBox1.value / 10))
 
  'background picture
    If Global.backimage <> Null Then 
      If FMain.picture <> Global.backimage.Stretch(FMain.w, FMain.h).picture Then
        FMain.picture = Global.backimage.Stretch(FMain.w, FMain.h).picture
        FMain.transparent = True
      Endif
        Else
      FMain.picture = Null
      If FMain.transparent = True Then 
        Try FMain.Transparent = False 
      Endif
    Endif
 
 
  'text fg/bg
  Global.text_foreground = colorbuttontextfg.value
  FMain.ResultGrid.background = colorbuttontextbg.value
  FMain.ResultGrid.Foreground = Global.text_foreground
  FMain.textbox2.Background = colorbuttontextbg.value
  FMain.TextBox2.Foreground = Color.Merge(Global.text_foreground, colorbuttontextbg.value, 0.75)
  FMain.TextBox1.Foreground = colorbuttontextfg.value
  
 
 
  'inner widgets opacity 
  wopacity = CInt(SpinBoxwopacity.value * (255 / 100))
  wopacitygrid = CInt(wopacity * (wopacity / 255)) 'hack for gambas bug (?)
  If wopacity = 0 Then wopacity = 1
  If wopacitygrid = 0 Then wopacitygrid = 1

  FMain.ResultGrid.background = Color.SetAlpha(FMain.ResultGrid.background, 255 - wopacitygrid)
  FMain.buttonconfigure.background = Color.SetAlpha(FMain.buttonconfigure.background, 255 - wopacity)
  FMain.textbox2.background = Color.SetAlpha(FMain.textbox2.background, 255 - wopacity)
  
  
  FMain.resize_form()
End

Public Sub CheckBox1_Click()
  Settings["style/undecorated"] = CheckBox1.value
  applystyle()
End

Public Sub SpinBox1_Change()
  Settings["style/padfactor"] = SpinBox1.value
  applystyle()
End

Public Sub ButtonPicture_Click()
  Dialog.title = ("Choose a picture")
  If Not Dialog.OpenFile() Then
    ButtonPicture.text = Dialog.path
    Settings["style/backpicture"] = ButtonPicture.text 
    Try Global.backimage = MySettings.loadBackimage(hSettings.ButtonPicture.text)
    If Error Then Debug "Could not load background image"
    applystyle()
  Endif
End

Public Sub ButtonPicture_Clear()
  Settings["style/backpicture"] = ""
  Global.backimage = Null
  applystyle()
End

Public Sub ButtonPicture_Activate()
  Settings["style/backpicture"] = ButtonPicture.text 
  Global.backimage = MySettings.loadBackimage(hSettings.ButtonPicture.text)
  Try Global.backimage = MySettings.loadBackimage(hSettings.ButtonPicture.text)
  If Error Then Debug "Could not load background image"
  applystyle()
End

Public Sub SpinBoxwopacity_Change()
  Settings["style/inneropacity"] = SpinBoxwopacity.value
  applystyle()
End

Public Sub ButtonPicture_Change()
  If ButtonPicture.text = "" Then Message.Error("Please restart higgins for changes to take effect")
End

Public Sub Button3_Click()
  colorbuttontextfg.value = Color.TextForeground
  Settings["style/textfg"] = colorbuttontextfg.value
  applystyle()
End

Public Sub colorbuttontextfg_Change()
  Applystyle()
  Settings["style/textfg"] = colorbuttontextfg.value
  Settings.Save
End


Public Sub Button4_Click()
  colorbuttontextbg.value = Color.TextBackground
  Settings["style/textbg"] = colorbuttontextbg.value
  applystyle()
End

Public Sub ColorButtontextbg_Change()
  Applystyle()
  Settings["style/textbg"] = colorbuttontextbg.value
  Settings.Save
End
